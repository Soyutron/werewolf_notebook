# プロジェクト概要 & アーキテクチャリファレンス

## 1. プロジェクトの目的
このプロジェクトは、AIエージェント（LLM駆動）が人間のプレイヤーをシミュレートするマルチエージェント「ワンナイト人狼」ゲームを実装するものです。中核となる目標は、自身の役職や記憶の状態に基づいて思考し、迷い、戦略的な決定を下す「主観的な認知」を持つエージェントを作成することです。

システムは、ゲームマスター（GM）とプレイヤーの両方の状態遷移と意思決定プロセスをモデル化するために **LangGraph** を使用しています。

## 2. 技術スタック
- **言語**: Python
- **フレームワーク**:
    - **FastAPI**: アプリケーションサーバーおよびAPIインターフェース。
    - **LangGraph**: エージェントのワークフロー（ステートマシン）のオーケストレーション。
    - **Pydantic**: データバリデーションとスキーマ定義。
- **LLM統合**: `src/core/llm` 内のカスタムラッパー（vLLM/OpenAI の可能性が高い）。

## 3. ディレクトリ構成

```text
/
├── README.md               # クイックスタート & フェーズロードマップ
├── pyproject.toml          # 依存関係（uvで管理）
├── scripts/                # ユーティリティスクリプト
├── notebooks/              # 実験用ノートブック
├── tests/                  # ユニットテストおよび統合テスト
└── src/                    # ソースコード
    ├── main.py             # エントリーポイント（FastAPIアプリ）
    ├── app/                # API層（MVCパターン）
    │   ├── controllers/    # APIルート
    │   ├── schemas/        # APIリクエスト/レスポンスモデル
    │   └── services/       # APIとゲームをつなぐアプリケーションロジック
    ├── core/               # コアインフラ（ゲーム非依存）
    │   ├── llm/            # LLMプロンプト & アダプター
    │   ├── memory/         # エージェントの記憶構造（信念、履歴）
    │   ├── roles/          # 役職レジストリ & 基本定義
    │   └── types/          # 共有型定義
    ├── game/               # ゲーム固有ロジック（ワンナイト人狼）
    │   ├── one_night.py    # ゲーム定義（役職、フェーズ）
    │   ├── gm/             # GM固有の汎用ロジック
    │   ├── player/         # プレイヤー固有の汎用ロジック
    │   ├── setup/          # ゲーム状態の初期化ロジック
    │   └── log_summarizer.py
    └── graphs/             # LangGraphエージェント実装
        ├── gm/             # GMエージェントグラフ
        └── player/         # プレイヤーエージェントグラフ
            ├── player_graph.py  # メインプレイヤーステートグラフ
            ├── phase_router.py  # フェーズ間のルーティングロジック
            └── node/            # グラフノード（アクション/推論ステップ）
```

## 4. 主要なアーキテクチャコンポーネント

### A. API層 (`src/app`)
ゲームセッションを開始および管理するためのエンドポイントを公開します。外部インターフェースを内部ゲームロジックから分離しています。

### B. コア層 (`src/core`)
エージェントの構成要素を提供します：
- **Memory**: 「主観的現実」（エージェントが信じていること vs 真実）を保持するための特殊な構造。
- **Roles**: 役職の振る舞いや勝利条件を動的に定義するレジストリシステム。

### C. ゲームロジック (`src/game`)
「ワンナイト人狼」のルールセットを含みます。
- `one_night.py`: ゲームの具体的な構成（人狼、占い師、村人など）を定義します。
- `setup/`: 役職のランダム配布と初期記憶の作成を処理します。

### D. エージェントグラフ (`src/graphs`)
- **PlayerGraph**: 単一プレイヤーの認知アーキテクチャ。以下を処理します：
    - `Input`: イベントの観察。
    - `Processing`: 内部信念と記憶の更新。
    - `Output`: アクション（発言、行動、投票）の決定。
- **GMGraph**: ゲームルールの遵守、ターン管理、フェーズ遷移を保証するオーケストレーター。

## 5. 実行フロー (Execution Flow)
1. **Startup**: `src/main.py` がFastAPIサーバーを起動します。
2. **Session Init**: リクエストが `src/app` 経由でセットアップをトリガーし、`GameSession` を初期化します。
3. **Loop**:
    - **GMGraph** が現在のフェーズを評価します。
    - GM が **PlayerGraphs** に指示を送ります。
    - **PlayerGraphs** がLLMを使用して認知ループ（観察 -> 思考 -> 行動）を実行します。
    - プレイヤーの出力がGM/セッションに返されます。
    - グローバル状態が更新されます。

## 6. 開発フェーズ (READMEより)
- **Phase 0-2**: 基本セットアップ、GMなし、シンプルスクリプト。
- **Phase 3**: イベント駆動ループ。
- **Phase 4**: プレイヤーのLangGraph化。
- **Phase 5**: GMのLangGraph化。
- **Phase 6**: 高度な戦略/推論。
- **Phase 7**: UI & 評価。
